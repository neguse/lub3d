<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lub3d Player</title>
  <style>
    * { margin: 0; padding: 0; }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    body {
      max-height: 100vh;
    }
    #canvas-wrapper {
      width: 100%;
      flex-shrink: 0;
      overflow: hidden;
    }
    canvas {
      image-rendering: pixelated;
    }
    #log-panel {
      width: 100%;
      flex: 1;
      min-height: 50px;
      background: #111;
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      overflow-y: auto;
      box-sizing: border-box;
      padding: 4px;
    }
    #log-panel .log-error { color: #f44; }
    #log-panel .log-warn { color: #fa0; }
    #log-panel .log-info { color: #0af; }
  </style>
</head>
<body>
  <div id="canvas-wrapper">
    <canvas id="canvas" width="480" height="360" tabindex="0"></canvas>
  </div>
  <div id="log-panel"></div>
  <script>
    // Log panel
    const logPanel = document.getElementById('log-panel')

    function addLog(msg, level = 'log') {
      const line = document.createElement('div')
      line.textContent = msg
      if (level !== 'log') line.className = 'log-' + level
      logPanel.appendChild(line)
      logPanel.scrollTop = logPanel.scrollHeight
      // Keep max 200 lines
      while (logPanel.children.length > 200) {
        logPanel.removeChild(logPanel.firstChild)
      }
      // Send to parent
      window.parent.postMessage({ type: 'log', msg, level }, '*')
    }

    // Intercept console
    const origLog = console.log
    const origError = console.error
    const origWarn = console.warn
    const origInfo = console.info
    console.log = (...args) => { origLog(...args); addLog(args.join(' '), 'log') }
    console.error = (...args) => { origError(...args); addLog(args.join(' '), 'error') }
    console.warn = (...args) => { origWarn(...args); addLog(args.join(' '), 'warn') }
    console.info = (...args) => { origInfo(...args); addLog(args.join(' '), 'info') }

    // Focus canvas on click for keyboard input
    document.getElementById('canvas').addEventListener('click', function() {
      this.focus()
    })
    window._editorCode = ''

    window.getEditorCode = () => window._editorCode
    window.onWasmReady = () => {
      window.parent.postMessage({ type: 'ready' }, '*')
    }

    window._canvasWidth = 480
    window._canvasHeight = 360

    window.Module = {
      canvas: document.getElementById('canvas'),
      onRuntimeInitialized: () => console.log('WASM runtime initialized'),
      print: (text) => { origLog(text); addLog(text) },
      printErr: (text) => { origError(text); addLog(text, 'log-error') }
    }

    // Update canvas resolution and scale display
    function setResolution(width, height) {
      const canvas = document.getElementById('canvas')
      const wrapper = document.getElementById('canvas-wrapper')

      // Calculate display scale to fit in viewport while maintaining aspect ratio
      const minLogHeight = 50
      const viewW = wrapper.clientWidth
      const maxCanvasH = window.innerHeight - minLogHeight

      let baseWidth = width
      let baseHeight = height
      if (width === 0 && height === 0) {
        // Native resolution - use window size
        baseWidth = viewW
        baseHeight = maxCanvasH
      }

      const scaleX = viewW / baseWidth
      const scaleY = maxCanvasH / baseHeight
      const displayScale = Math.min(scaleX, scaleY)

      // Buffer size = base resolution (keeps rendering fast)
      window._canvasWidth = baseWidth
      window._canvasHeight = baseHeight
      canvas.width = baseWidth
      canvas.height = baseHeight

      // Store display scale for Lua to read via C binding
      window._displayScaleX = displayScale
      window._displayScaleY = displayScale

      // CSS size matches buffer - transform handles visual scaling
      canvas.style.width = baseWidth + 'px'
      canvas.style.height = baseHeight + 'px'
      canvas.style.transform = `scale(${displayScale})`
      canvas.style.transformOrigin = 'top left'

      // Set wrapper height to match scaled canvas
      const scaledHeight = Math.floor(baseHeight * displayScale)
      wrapper.style.height = scaledHeight + 'px'

      console.log(`Resolution: ${baseWidth}x${baseHeight}, display scale: ${displayScale.toFixed(2)}`)
    }

    // Wait for messages from parent
    window.addEventListener('message', (e) => {
      if (e.data.type === 'setResolution') {
        setResolution(e.data.width, e.data.height)
      } else if (e.data.type === 'setCode') {
        window._editorCode = e.data.code
        // Now load WASM script
        const script = document.createElement('script')
        script.src = '/lub3d-example.js'
        script.async = true
        document.body.appendChild(script)
      }
    })

    // Tell parent we're ready to receive code
    window.parent.postMessage({ type: 'playerReady' }, '*')
  </script>
</body>
</html>
